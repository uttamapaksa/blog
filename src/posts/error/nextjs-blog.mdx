---
id: 1
title: "Next.js 블로그"
datetime: "2024-12-23"
category: "Error"
thumbnail: "/favicon-wide.jpg"
source: "https://product.kyobobook.co.kr/detail/S000001766397"
summary: "uttamapaksa.me"
---

#### 국문/영문 폰드 별도 적용 ❌ <small className="text-gray-500">24.11.05.</small>
`@font-face`의 `unicode-range`를 사용하여 한글에만 나눔바른고딕을 적용하였지만, 강제 새로고침 시에 레이아웃 시프트(FOUT/FOIT)가 발생하였다. 주석처리하고 Next.js의 글꼴 관리 기능인 `next/font`로 변경하였다. `next/font`의 `localFont`는 빌드 시점에 글꼴을 다운로드하여 포함시키고 자동으로 최적화 해주기 때문에 레이턴시가 발생하지 않는다. `global.css`는 전역 스타일 시트로서 body의 css변수를 참조할 수 있게 되어있다. `layout.tsx`에서 `localFont`로 글꼴을 선언하고 body에 클래스로 집어넣으면 `global.css`에서 CSS 변수로 사용할 수 있다.
<br/>

#### Next.js Github Pages 배포 ✅ <small className="text-gray-500">24.11.06.</small>
Github Action을 사용했다. 정확히는 `peaceiris/actions-gh-pages` 액션을 통해 master 브랜치를 기반으로 빌드된 정적 파일들을 gh-pages에 publish하도록 yml 파일을 작성했다. Repository > Settings > Pages > Build and deployment > Deploy from a branch 에서 gh-pages 브랜치를 선택해주기만 하면 배포가 완료된다.
<br/>

#### Github Pages 동적 라우팅 ⚠️ <small className="text-gray-500">24.11.08.</small>
Github Pages는 SSG만 지원하기 때문에 dynamic routing이 불가능하다. 그래서 모든 페이지를 미리 다 빌드해놓아야 한다. 검색해보면 page router와 `getStaticProps`를 쓰는 경우가 대부분인데 나는 app router로 구현했기 때문에 `generateStaticParams`를 사용하였다. `generateStaticParams`를 이용하면 설정한 경로들에 대한 data fetching까지 빌드 시에 모두 이루어진다! `npm run bulid`를 하고 콘솔을 찍어보면 알 수 있다. 다만 배포 과정에서 자꾸 오류가 발생해서 마무리하진 못했다. 정적 파일로 내보내기, sharp 모듈 오류, 이미지 최적화, 다크모드 등 여러 면에서 번거로운 점이 많았다. 결국 Github Blog를 포기하고 Vercel로 배포 환경을 옮겼다.
<br/>

#### MDX 내용 스타일 적용 ✅ <small className="text-gray-500">24.11.09.</small>
`.mdx` 파일을 파싱해서 HTML로 변환을 마쳤는데 스타일이 적용되지 않았다. Network 탭에선 잘 받았는데 화면에서는 마크다운 태그들이 순수 문자열로 출력됐다. 서버 컴포넌트에서 파라미터에 맞는 폴더명과 파일 내용을 `fs` 모듈로 비동기로 다 읽어오면, `next-mdx-remote` 라이브러리를 통해 frontmatter와 content로 나누고 HTML로 변환해서 Page 컴포넌트까지 잘 전달했다. 문제는 HTML을 받는 엘리먼트에 Tailwind의 `prose` 클래스를 넣고 `tailwind typography` 플러그인을 다운받아야 했다. 이 부분을 놓쳐 하루를 통째로 날렸다.
<br/>

#### 다크모드 플리커링 해결 ✅ <small className="text-gray-500">24.11.12.</small>
FOUC(Flash of Unstyled Content) 문제. 다크모드에서 새로고침을 하면 잠깐 동안 라이트모드였다가 다크모드로 바뀌어 화면이 깜빡이는 문제다. 렌더링이 완료된 후에 자바스크립트로 테마 스타일이 적용되면 발생한다. `dangerouslySetInnerHTML`라는 인라인 스크립트를 활용했다. html에 다크모드 적용 스크립트 태그를 삽입하면 HTML 파싱을 멈추고 자바스크립트가 실행되어 렌더트리가 완성되기 전에 body에 다크모드 클래스를 추가하는 원리이다. 플리커링 방지만을 목적으로 한다면 쿠키에 테마 정보를 저장하고 서버 사이드에서 body에 클래스를 추가해 CSSOM 트리에 미리 반영되도록 하는 방식이 훨씬 간편하고, hydration 오류도 발생하지 않는다. 하지만 `window.matchMedia`를 통해 시스템 설정을 미리 읽어오는 것은 브라우저의 클라이언트측 API라서 쿠키로 해결할 수 없었다. 추가로 `tailwind.config.ts`에 `darkMode: 'selector'`를 설정해야 Tailwind가 dark 클래스를 감지하고 스타일을 적용할 수 있다.
<br/>

#### 이미지 최적화 ⚠️ <small className="text-gray-500">24.11.16.</small>
이미지 최적화의 핵심 중 하나는 크기 조정이다. 성능 저하와 레이아웃 시프트를 방지할 수 있다. 가장 편한 방법은 local image를 static import하는 것이다. Next.js의 `<Image />` 태그는 자동으로 크기를 조정해준다. jpg 파일을 모두 .webp로 변환해서 저장했다. 크기는 모두 fill 속성으로 통일했다. 반응형 sizes 속성, remote image 최적화, device size에 따른 최적화 등 아직 개선의 여지가 많다.
<br/>

#### 네비게이션 하이라이트 CSS ✅ <small className="text-gray-500">24.12.13.</small>
usePathname으로 현재 url을 가져와서 현재 메뉴에 bottom border로 하이라이트를 주고, hover 시에는 다른 색깔의 bottom border를 준다. border를 주니까 그 두께만큼 글자가 올라가는 문제가 있었다. border를 늘 유지하고 transparent를 기본값으로 하도록 변경했다가, hover된 메뉴 이름이 올라오는 것도 하이라이트 효과로 좋은 거 같아서 되돌렸다. 
<br/>

#### Link 태그 중첩 오류 ✅ <small className="text-gray-500">24.12.22.</small>
클릭 요소 안에 다른 클릭 요소를 배치하는 것은 아주 흔하다. 포스트 목록 안에 카테고리 버튼을 넣어야 했다. 그러나 `Link` 태그 중첩은 이벤트 중첩으로서 권장되지 않는다. 부모는 `Link` 태그를 사용하고 자식은 클라이언트 컴포넌트로 변경 후 `useRouter`를 사용했다. `stopPropagation()`는 이벤트 전파를 막지만 기본 동작을 막지는 못하기 때문에 부모의 기본 동작(페이지 이동)이 여전히 작동한다. `preventDefault()`를 사용해야 한다.
<br/>

#### 카테고리에 따른 포스트 필터링 ✅ <small className="text-gray-500">24.12.23.</small>
메뉴 페이지에서 포스트트의 카테고리 별로 필터링 할 수 있게 변경했다. 웬만하면 서버 컴포넌트로만 해결하려 했는데 필터링 기능은 어쩔 수 없었다. 필터링을 위한 클라이언트 컴포넌트를 새로 만들고 서버 컴포넌트에서 페칭해놓은 포스트 목록을 props로 보냈다. 카테고리만 모아놓는 페이지는 사용하는 데이터 페칭 함수가 달라서 정적 라우팅으로 별도로 만들었다.
<br/>

#### useState 무한 렌더링 오류 ✅ <small className="text-gray-500">24.12.25.</small>
컴포넌트 내에서 그냥 상태를 업데이트하면, 갱신 &rarr; 렌더링 &rarr; 다시 setter 호출을 해서 무한히 렌더링된다. `new Set()`의 참조값 변경 때문인 줄 알았는데, setter 호출만 하면 (상태가 바뀌지 않아서 DOM 업데이트를 건너뛰더라도) 무조건 다시 렌더링이 된단다. state는 immutable 권장이라서 새 객체를 생성하는 건 맞다. 갱신 조건식을 `useState` 초기값에 넣어서 해결했다. 이 초기값 계산식은 함수 형태로 넣어야 좋다. 계산식 자체를 넣으면 렌더링마다 (상태 업데이트는 되지 않지만) 계산이 다시 이루어진다. 쿼리 파라미터를 읽어 클릭된 카테고리 포스트 목록을 보여주는 과정에서 발생했다. 근데 같은 페이지에서 클릭 시 이미 초기화된 상태는 업데이트가 안돼서 `useEffect`로 바꿨다. 
<br/>