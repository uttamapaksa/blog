---
id: 1
title: "Next.js 블로그"
datetime: "2024-11-5"
category:
  title: "Errors"
  href: "#"
thumbnail: "/favicon-wide.jpg"
source: "https://product.kyobobook.co.kr/detail/S000001766397"
summary: ""
---

#### 국문/영문 폰드 별도 적용 ❌ <small className="text-gray-500">24.11.05.</small>
`@font-face`의 `unicode-range`를 사용하여 한글에만 나눔바른고딕을 적용하였지만, 강제 새로고침 시에 레이아웃 시프트(FOUT/FOIT)가 발생하였다. 주석처리하고 Next.js의 글꼴 관리 기능인 `next/font`로 변경하였다. `next/font`의 `localFont`는 빌드 시점에 글꼴을 다운로드하여 포함시키고 자동으로 최적화 해주기 때문에 레이턴시가 발생하지 않는다. `global.css`는 전역 스타일 시트로서 body의 css변수를 참조할 수 있게 되어있다. `layout.tsx`에서 `localFont`로 글꼴을 선언하고 body에 클래스로 집어넣으면 `global.css`에서 CSS 변수로 사용할 수 있다.
<br/>

#### Next.js Github Pages 배포 ✅ <small className="text-gray-500">24.11.06.</small>
Github Action을 사용했다. 정확히는 `peaceiris/actions-gh-pages` 액션을 통해 master 브랜치를 기반으로 빌드된 정적 파일들을 gh-pages에 publish하도록 yml 파일을 작성했다. Repository > Settings > Pages > Build and deployment > Deploy from a branch 에서 gh-pages 브랜치를 선택해주기만 하면 배포가 완료된다.
<br/>

#### Github Pages 동적 라우팅 ⚠️ <small className="text-gray-500">24.11.08.</small>
Github Pages는 SSG만 지원하기 때문에 dynamic routing이 불가능하다. 그래서 모든 페이지를 미리 다 빌드해놓아야 한다. 검색해보면 page router와 `getStaticProps`를 쓰는 경우가 대부분인데 나는 app router로 구현했기 때문에 `generateStaticParams`를 사용하였다. 다만 배포 과정에서 자꾸 오류가 발생해서 마무리하진 못했다. 정적 파일로 내보내기, sharp 모듈 오류, 이미지 최적화, 다크모드 등 여러 면에서 번거로운 점이 많다 보니 이참에 Github Blog를 포기하고 Vercel로 옮겨야겠다고 생각했다.
<br/>

#### MDX 내용 스타일 적용 ✅ <small className="text-gray-500">24.11.09.</small>
`.mdx` 파일을 파싱해서 HTML로 변환을 마쳤는데 스타일이 적용되지 않았다. Network 탭에선 잘 받았는데 화면에서는 마크다운 태그들이 순수 문자열로 출력됐다. 파라미터에 맞는 폴더명과 파일 내용을 `fs` 모듈로 비동기로 다 읽어오면, `next-mdx-remote` 라이브러리를 통해 metadata와 content로 나누고 HTML로 변환해서 Page 컴포넌트까지 잘 전달했다. 문제는 HTML을 받는 엘리먼트에 Tailwind의 `prose` 클래스를 넣고 `tailwind typography` 플러그인을 다운받아야 했다. 이 부분을 놓쳐 하루를 통째로 날렸다.
<br/>

#### 다크모드 플리커링 해결 ✅ <small className="text-gray-500">24.11.12.</small>
FOUC(Flash of Unstyled Content) 문제. 다크모드에서 새로고침을 하면 잠깐동안 라이트모드였다가 다크모드로 바뀌어 화면이 깜빡이는 문제다. 렌더트리가 만들어진 이후에 자바스크립트를 실행돼서, 추가적인 스타일 적용이 렌더링 이후에 일어나기 때문이다. 렌더링 전에 다크모드가 적용되도록 쿠키에 다크모드 정보를 저장하고 서버 사이드에서 body에 클래스를 추가해 CSSOM 트리에 미리 반영되도록 하여 해결했다. 보통 `dangerouslySetInnerHTML`라는 인라인 스크립트와 `next-themes` 라이브러리를 많이 사용하는 것 같다. 전자는 html에 다크모드 적용 스크립트 태그를 삽입하면 HTML 파싱을 멈추고 자바스크립트가 실행되어 렌더트리가 완성되기 전에 body에 다크모드 클래스를 추가한다. 쿠키 방식이 더 쉽다. SSG 환경에선 쓸 수 없기 때문에 배포 환경을 GitHub Pages에서 SSR이 지원되는 Vercel로 변경했다. 또한 `tailwind.config.ts`에 `darkMode: 'selector'`를 설정해야 Tailwind가 dark 클래스를 감지하고 스타일을 적용할 수 있다.
<br/>

#### 이미지 최적화 ⚠️ <small className="text-gray-500">24.11.16.</small>
이미지 최적화의 핵심 중 하나는 크기 조정이다. 성능 저하와 레이아웃 시프트를 방지할 수 있다. 가장 편한 방법은 local image를 static import하는 것이다. Next.js의 `<Image />` 태그는 자동으로 크기를 조정해준다. jpg 파일을 모두 .webp로 변환해서 저장했다. 크기는 모두 fill 속성으로 통일했다. 반응형 sizes 속성, remote image 최적화, device size에 따른 최적화 등 아직 개선의 여지가 많다.